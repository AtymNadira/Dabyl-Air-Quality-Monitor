#ifdef ESP32
  #include <WiFi.h>
#else
  #include <ESP8266WiFi.h>
#endif
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h> 
#include <ArduinoJson.h>
#include <Adafruit_BME280.h>
#include <Adafruit_Sensor.h>
#include<string.h>
#include <Arduino.h>
#include <ESP8266WiFi.h>
#include <Hash.h>
#include <ESPAsyncTCP.h>
#include <ESPAsyncWebServer.h>
#include <FS.h>
#include <Wire.h>
const char* ssid = "NASA";
const char* password = "Nouan2525";
const char* host = "192.168.100.140"; 
AsyncWebServer server(80);
//#define CHAT_ID "209245534"

#define BOTtoken "5806952844:AAE-TE44qc3AoC4GT2aE_F4slXLPXzy59Oo" 
WiFiClientSecure client;
UniversalTelegramBot bot(BOTtoken, client);
int botRequestDelay = 1000;
unsigned long lastTimeBotRan;
// BME280 connect to ESP32 I2C (GPIO 21 = SDA, GPIO 22 = SCL)
// BME280 connect to ESP8266 I2C (GPIO 4 = SDA, GPIO 5 = SCL)
Adafruit_BME280 bme;         
int pin1 = D5;
int pin2 = D6;
unsigned long duration1;
unsigned long duration2;
unsigned long starttime;
unsigned long sampletime_ms = 1000;//sampe 1s ;
unsigned long lowpulseoccupancy1 = 0;
unsigned long lowpulseoccupancy2 = 0;
float ratio1 = 0;
float ratio2 = 0;
float concentration1 = 0;
float concentration2 = 0;
int i=0;
float conPM1, conPM25;
float temperature, humidity;
const int analogSignal = A0;
int gasValue = 0;
// Отправка значений с датчика BME280
String getReadings(){
  String message = "Temperature: " + String(temperature) + " ºC \n";
  message += "Humidity: " + String (humidity) + " % \n";
  message += "conPM10: " + String (conPM1) + " pcs/0.01cf  \n";
  message += "conPM2.5: " + String (conPM25) + " pcs/0.01cf \n";
  message += "Gas: " + String (gasValue) + " \n";
      if (conPM25 < 1.0) {
     message += " Воздух пригодный / ауа тыныс алуға жарамды\n"; 
  }
    if (conPM25 > 1.0 && conPM25 < 2000) {
     message += "Есть твердые частицы но дышать можно / ауада қатты бөлшектер бар,брақ,тыныс алуға жарамды\n"; 
    }
        if (conPM25 > 20000 && conPM25 < 31500) {
     message += " Уровень твердых частиц повышен / қатты бөлшектердің саны жоғары\n";  
    }
      if (conPM25 > 31500) {
     message +="Осторожно! уровень твердых частиц превышен!/ Сақ болыңыз! Қатты бөлшектердің саны тым көп!"; 
  }
  return message;
}
void handleNewMessages(int numNewMessages) {
  Serial.println("handleNewMessages");
  Serial.println(String(numNewMessages));

  for (int i=0; i<numNewMessages; i++) {
    // Chat id of the requester
   String chat_id = String(bot.messages[i].chat_id);
    /*if (chat_id != CHAT_ID){
      bot.sendMessage(chat_id, "Unauthorized user", "");
      continue;
    }*/
    String text = bot.messages[i].text;
    Serial.println(text);
    String from_name = bot.messages[i].from_name;
    if (text == "/start") {
      String welcome = "Welcome, " + from_name + ".\n";
      welcome += "Use the following command to get current readings.\n\n";
      welcome += "/readings \n";
      bot.sendMessage(chat_id, welcome, "");
    }
    if (text == "/климат") {
      String readings = getReadings();
      bot.sendMessage(chat_id, readings, "");
    }  }}
String PM10() {
    return String(conPM1);}
String PM25() {
    return String(conPM25);}
  String TM() {
    return String(temperature);}
String HM() {
    return String(humidity);}
void setup() {
  Serial.begin(115200);
  Wire.begin();
  if(!SPIFFS.begin()){
    Serial.println("An Error has occurred while mounting SPIFFS");
    return;}
  #ifdef ESP8266
    client.setInsecure();
  #endif
  // Здесь задается адрес BME устройства
  if (!bme.begin(0x76)) {
    Serial.println("Could not find a valid BME280 sensor, check wiring!");}
    // Подключение к wi-fi
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi..");}
  // Отправка ip адреса в компорт
  Serial.println(WiFi.localIP());
  Serial.println("Starting please wait 30s");
  pinMode(pin1,INPUT);
  pinMode(pin2,INPUT);
  starttime = millis();//get the current time; 
  const int analogSignal = A0;
   // Route for root / web page
  server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){
    request->send(SPIFFS, "/index.html");
  });
  server.on("/temperature", HTTP_GET, [](AsyncWebServerRequest *request){
    request->send_P(200, "text/plain", TM().c_str());
  });
  server.on("/humidity", HTTP_GET, [](AsyncWebServerRequest *request){
    request->send_P(200, "text/plain", HM().c_str());
  });
  server.on("/PM10", HTTP_GET, [](AsyncWebServerRequest *request){
    request->send_P(200, "text/plain", PM10().c_str());
  });
  server.on("/PM25", HTTP_GET, [](AsyncWebServerRequest *request){
    request->send_P(200, "text/plain", PM25().c_str());
  });
  server.on("/PM25", HTTP_GET, [](AsyncWebServerRequest *request){
    request->send_P(200, "text/plain", PM25().c_str());
  });
  // Start server
  server.begin();
}
void loop() {
      temperature = bme.readTemperature();
  humidity = bme.readHumidity();
  gasValue = analogRead(analogSignal);
  duration1 = pulseIn(pin1, LOW);
  duration2 = pulseIn(pin2, LOW);
  lowpulseoccupancy1 = lowpulseoccupancy1+duration1;
  lowpulseoccupancy2 = lowpulseoccupancy2+duration2;

  if ((millis()-starttime) > sampletime_ms)//if the sampel time == 30s
  {
    ratio1 = lowpulseoccupancy1/(sampletime_ms*10.0);  // Integer percentage 0=>100
    ratio2 = lowpulseoccupancy2/(sampletime_ms*10.0);  // Integer percentage 0=>100
    concentration1 = 1.1*pow(ratio1,3)-3.8*pow(ratio1,2)+520*ratio1+0.62; // using spec sheet curve
    concentration2 = 1.1*pow(ratio2,3)-3.8*pow(ratio2,2)+520*ratio2+0.62; // using spec sheet curve
    conPM1=concentration1;
    conPM25=concentration2;
    lowpulseoccupancy1 = 0;
    lowpulseoccupancy2 = 0;
    starttime = millis();
  }
   WiFiClient client;
   if (client.connect(host, 80)) {  
    client.println(conPM25);
    client.stop();
  }
  if (millis() > lastTimeBotRan + botRequestDelay)  {
    int numNewMessages = bot.getUpdates(bot.last_message_received + 1);

    while(numNewMessages) {
      Serial.println("got response");
      handleNewMessages(numNewMessages);
      numNewMessages = bot.getUpdates(bot.last_message_received + 1);
    }
    lastTimeBotRan = millis();
  }
}
